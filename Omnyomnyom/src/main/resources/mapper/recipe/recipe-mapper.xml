<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="recipe">

	<select id="selectIngSubCtg" resultType="string">
		select ing_cd_category  from (select * from tb_ingredient where ing_pr_category = #{mainCtg}) group by ing_cd_category order by ing_cd_category
	</select>
	
	<select id="selectIngredients" resultType="Ingredient">
		select * from tb_ingredient where ing_cd_category = #{subCtg}
	</select>
	
	
	<select id="selectIngredientsCnt" resultType="_int">
		select count(*) from tb_ingredient where ing_cd_category = #{subCtg}
	</select>
  
	
	<select id="ingredientAjax" resultType="ingredient">
		select *
		from TB_Ingredient
		where ingredient_name like '%'||#{ingr}||'%'
	</select>
	<insert id="recipeUpload" parameterType="recipe">
		insert into 
			TB_recipe
		values(
			seq_recipe.nextval,
			#{videoTitle},
			#{videoLink},
			#{timeline},
			#{menuName},
			#{chefNick},
			#{chefId},
			#{cookingTime},
			#{category},
			#{recipeContent},
			default,
			default
		)
		<selectKey keyProperty="recipeNo" resultType="_int" order="AFTER">
			select seq_recipe.currval from dual
		</selectKey>
	</insert>
	<insert id="recipeIngrUpload" parameterType="recipeIngredient">
		insert into
			tb_rec_Ingredients
		values(
			#{recipeNo},
			<choose>
				<when test="ingredientNo!=0">
					#{ingredientNo},
				</when>
				<when test="ingredientNo==0">
					null,
				</when>
			</choose>
			#{minWeight},
			#{ingredientName}
		)
	</insert>
	<select id="selectRecipeOne" resultType="recipe">
		select 
			*
		from 
			tb_recipe 
		where 
			recipe_no=#{recipeNo}
	</select>
	<select id="selectRecIngList" resultType="recipeIngredient">
		select 
			*
		from 
			tb_rec_ingredients 
		where 
			recipe_no=#{recipeNo}
	</select>
	
	<select id="recipeSerachByIng" resultType="recipeWithIngCnt">
		    SELECT J.INCLUDE_NO, C.CHEF_PROFILE, R.* 
		    	FROM TB_RECIPE R JOIN 
		    		(SELECT COUNT(*) INCLUDE_NO, T.RECIPE_NO 
		    			FROM (SELECT * FROM TB_REC_INGREDIENTS WHERE INGREDIENT_NO IN
							<if test="ingNoArr != null">				
							<foreach collection="ingNoArr" item="item" open="(" separator="," close=")">
								#{item}
							</foreach>
							</if>
							) T GROUP BY RECIPE_NO ORDER BY 1 DESC) J 
                ON R.RECIPE_NO = J.RECIPE_NO
                LEFT JOIN TB_CHEF C ON R.CHEF_ID = C.MEMBER_ID
	</select>
	
	
	<select id="selectPopRecipe" resultType="recipeWithIngCnt">
		SELECT * FROM(
			SELECT ROWNUM RNUM, P.* FROM (
				SELECT R.*, C.CHEF_PROFILE FROM TB_RECIPE R LEFT JOIN TB_CHEF C ON R.CHEF_ID = C.MEMBER_ID ORDER BY VIEW_COUNT) P
			)WHERE RNUM &lt; 11
	</select>
	
	<select id="selectPopIngredient" resultType="Ingredient">
	SELECT * FROM 
		(SELECT ROWNUM RNUM, I.* FROM TB_INGREDIENT I RIGHT JOIN 
				(SELECT COUNT(*) CNT, INGREDIENT_NO FROM TB_REC_INGREDIENTS WHERE INGREDIENT_NO IS NOT NULL  GROUP BY INGREDIENT_NO  ORDER BY CNT DESC) P
                    ON I.INGREDIENT_NO = P.INGREDIENT_NO
                    <where>
	                    <if test="subCtg != null">
	                    AND ING_CD_CATEGORY = #{subCtg}  
	                    </if>
	                    <if test="mainCtg != null">
	                    AND ING_PR_CATEGORY = #{mainCtg}  
	                    </if>
                    </where>
                    )
		WHERE RNUM &lt; 13
	</select>
	
	<select id="selectMenuSubCtg" resultType="string">
		select * from tb_menu_ctg;
	</select>	
</mapper>